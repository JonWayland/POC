<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../images/sand_dollar_favicon_64.png" sizes="64x64" type="image/png">
  <title>PDF Watermarker | The Dollar Web</title>
  <style>
    /* Inter and Montserrat Fonts */
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 400;
      src: url('/fonts/inter-regular.woff2') format('woff2');
    }
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 500;
      src: url('/fonts/inter-medium.woff2') format('woff2');
    }
    @font-face {
      font-family: 'Inter';
      font-style: normal;
      font-weight: 600;
      src: url('/fonts/inter-semibold.woff2') format('woff2');
    }

    @font-face {
      font-family: 'Montserrat';
      font-style: normal;
      src: url('/fonts/Montserrat-VariableFont_wght.ttf') format('truetype-variations');
      font-weight: 100 900; /* This tells the browser this file contains all weights */
      font-display: swap;
    }

    @font-face {
      font-family: 'Montserrat';
      font-style: italic;
      src: url('/fonts/Montserrat-Italic-VariableFont_wght.ttf') format('truetype-variations');
      font-weight: 100 900;
      font-display: swap;
    }

    :root {
      --primary: #00a896;
      --secondary: #f8b500;
      --accent: #ff6b6b;
      --light: #f8f9fa;
      --dark: #05668d;
      --text: #333;
      --bg: #f5f9f8;
      --highlight: rgba(255, 241, 118, 0.4); /* Default highlight color */
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' opacity='0.03' viewBox='0 0 120 120'%3E%3Cpath d='M20,60 C20,60 35,30 60,30 C85,30 100,60 100,60 C100,60 85,90 60,90 C35,90 20,60 20,60 Z' fill='%2300a896'/%3E%3C/svg%3E");
      background-size: 120px;
      padding-top: 70px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 60px;
    }
    
    header {
      text-align: center;
      padding: 40px 0 0px;
    }
    
    h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 3.2rem;
      color: var(--primary);
      margin-bottom: 1.2rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-top: 80px;
    }
    
    p.tagline {
      font-size: 1.3rem;
      color: var(--dark);
      max-width: 700px;
      margin: 0 auto 2rem;
      line-height: 1.6;
      font-weight: 300;
    }

    /* Navigation Bar Styles */
    .main-nav {
      background: white;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2000;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.5rem;
      transition: all 0.2s;
    }

    .nav-logo:hover {
      transform: translateY(-2px);
    }

    .nav-logo svg {
      margin-right: 10px;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .nav-links a {
      color: var(--dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: var(--primary);
    }

    .login-btn {
      background: var(--primary);
      color: white !important;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.2s !important;
    }

    .login-btn:hover {
      background: var(--dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Footer Styles */
    .site-footer {
      background: var(--dark);
      padding: 40px 0 50px;
      margin-top: 80px;
      position: relative;
      color: white;
    }

    .footer-wave {
      position: absolute;
      top: -120px;
      left: 0;
      right: 0;
      height: 120px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' width='1200' height='120' opacity='0.1'%3E%3Cpath d='M0,100 C200,20 400,60 600,80 C800,100 1000,40 1200,120 L1200,120 L0,120 Z' fill='%23ffffff'/%3E%3C/svg%3E");
      background-repeat: repeat-x;
      background-position: bottom;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .footer-logo {
      display: flex;
      align-items: center;
      margin-bottom: 40px;
      color: var(--secondary);
    }

    .footer-logo svg {
      width: 48px;
      height: 48px;
      margin-right: 16px;
    }

    .footer-logo span {
      font-weight: 600;
      font-size: 2.4rem;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 40px;
    }

    .footer-links a {
      color: var(--light);
      text-decoration: none;
      margin: 0 30px;
      font-size: 1.8rem;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: var(--secondary);
    }

    .footer-social {
      display: flex;
      gap: 30px;
      margin-bottom: 40px;
    }

    .footer-social a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.2s;
    }

    .footer-social a svg {
      width: 40px;
      height: 40px;
    }

    .footer-social a:hover {
      background: var(--secondary);
      color: var(--dark);
      transform: translateY(-3px);
    }

    .copyright {
      font-size: 1.8rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .copyright-message {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .secondary-text {
      color: var(--secondary);
    }
    
    .tertiary-text {
      color: var(--dark);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .nav-links {
        gap: 15px;
      }
      
      .nav-logo span {
        font-size: 1.2rem;
      }
      
      .footer-links {
        flex-direction: column;
        gap: 20px;
      }
      
      .footer-links a {
        margin: 10px 0;
      }
    }

    @media (max-width: 576px) {
      .nav-links a:not(.login-btn) {
        display: none;
      }
    }

    /* PDF Watermark Specific Styles */
    .tool-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      margin-top: 40px;
    }
    
    /* Drop Zone */
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      transition: all 0.3s;
      background-color: var(--light);
      position: relative;
      cursor: pointer;
    }
    
    .drop-zone.highlight {
      background: rgba(0, 168, 150, 0.05);
      border-color: var(--primary);
    }
    
    .drop-zone p {
      font-size: 1.2rem;
      color: var(--text);
      margin-bottom: 20px;
    }
    
    .drop-zone .icon {
      display: block;
      margin: 0 auto 15px;
      opacity: 0.5;
    }
    
    .drop-zone .link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 500;
    }
    
    .drop-zone input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Status indicator */
    #status {
      margin: 10px 0 20px;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 500;
      display: none;
    }
    
    #status.success {
      background-color: rgba(0, 168, 150, 0.1);
      color: var(--primary);
    }
    
    #status.error {
      background-color: rgba(255, 107, 107, 0.1);
      color: var(--accent);
    }

    /* Watermark Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .control-group input,
    .control-group select {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 168, 150, 0.2);
    }
    
    .control-group input[type="color"] {
      height: 46px;
      padding: 5px;
    }
    
    .control-group input[type="range"] {
      height: 6px;
      border: none;
      border-radius: 10px;
      background: #ddd;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      margin-top: 8px;
    }
    
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
    }
    
    .opacity-value {
      display: inline-block;
      margin-top: 8px;
      font-weight: 600;
      color: var(--primary);
    }

    /* Document Name Field */
    .document-name {
      margin-bottom: 20px;
    }
    
    .document-name label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .document-name input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .document-name input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 168, 150, 0.2);
    }

    /* Process Button */
    .process-btn {
      width: 100%;
      padding: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .process-btn:hover:not(:disabled) {
      background: var(--dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .process-btn:disabled {
      background: #aad3cf;
      cursor: not-allowed;
    }

    /* Note */
    .note {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 168, 150, 0.05);
      border-radius: 8px;
      color: var(--dark);
    }

    /* Preview Section */
    .preview-container {
      display: flex;
      gap: 30px;
      margin-top: 40px;
    }
    
    .preview-container.hidden {
      display: none;
    }
    
    .preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .preview-header {
      background: var(--dark);
      color: white;
      padding: 15px;
      font-weight: 600;
      text-align: center;
    }
    
    .preview iframe {
      width: 100%;
      height: 400px;
      border: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
      }
      
      .preview-container {
        flex-direction: column;
      }
      
      .container {
        padding: 20px;
      }
      
      .tool-container {
        padding: 20px;
      }
      
      h1 {
        font-size: 2.4rem;
      }
    }

    /* Loading indicator */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s;
    }
    
    .loading.active {
      visibility: visible;
      opacity: 1;
    }
    
    .loading-content {
      background: white;
      padding: 30px 60px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 168, 150, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="main-nav">
      <div class="container nav-container">
        <a href="../index.html" class="nav-logo">
          <img src="../images/logo.svg" alt="The Dollar Web Logo" style="width: 32px; height: 32px;">
          <span class="tertiary-text">&nbsp;The&nbsp;</span>Dollar&nbsp;<span class="secondary-text">Web</span>
        </a>
        <div class="nav-links">
          <a href="../index.html">Home</a>
          <a href="../tools.html">Tools</a>
          <a href="../about.html">About</a>
          <a href="../login.html" class="login-btn">Login</a>
        </div>
      </div>
    </nav>
  
    <div class="container">
      <header>
        <h1>PDF Watermark Tool</h1>
        <p class="tagline">Add customizable text watermarks to your PDF documents. Adjust text, color, opacity, and position to create professional watermarks that protect your content.</p>
      </header>
      
      <div class="tool-container">
        <!-- Drag & Drop Zone -->
        <div id="drop-zone" class="drop-zone">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <p>Drag & drop a PDF here, or <span class="link">click to browse</span></p>
          <input type="file" id="file-input" accept=".pdf,application/pdf">
        </div>
        
        <!-- Status Indicator -->
        <div id="status"></div>
  
        <div class="controls">
          <div class="control-group">
            <label for="watermark-text">Watermark Text:</label>
            <input type="text" id="watermark-text" placeholder="e.g. CONFIDENTIAL" value="CONFIDENTIAL">
          </div>
          
          <div class="control-group">
            <label for="font-size">Font Size:</label>
            <input type="number" id="font-size" value="48" min="8" max="200">
          </div>
          
          <div class="control-group">
            <label for="color-picker">Color:</label>
            <input type="color" id="color-picker" value="#FF0000">
          </div>
          
          <div class="control-group">
            <label for="opacity">Opacity:</label>
            <input type="range" id="opacity" min="0" max="100" value="25">
            <span id="opacity-val" class="opacity-value">25%</span>
          </div>
          
          <div class="control-group">
            <label for="position">Position:</label>
            <select id="position">
              <option value="center">Center</option>
              <option value="diagonal">Diagonal</option>
              <option value="top">Top</option>
              <option value="bottom">Bottom</option>
              <option value="repeated">Repeated (Tiled)</option>
            </select>
          </div>
        </div>
  
        <button id="add-watermark-btn" class="process-btn" disabled>
          Add Watermark & Preview
        </button>
        
        <!-- FIXED: Only one Document Name section -->
        <div id="download-container" style="margin-top: 20px; display: none;">
          <div class="document-name">
            <label for="doc-name">Document Name:</label>
            <input type="text" id="doc-name" placeholder="Enter document name (optional)">
          </div>
          
          <button id="download-btn" class="process-btn" style="background-color: var(--secondary);">
            Download Watermarked PDF
          </button>
        </div>
        
        <p class="note">All processing happens in your browserâ€”no files are uploaded to external servers.</p>
  
        <!-- Preview Panels -->
        <div id="preview-container" class="preview-container hidden">
          <div class="preview">
            <div class="preview-header">Original</div>
            <iframe id="orig-preview"></iframe>
          </div>
          <div class="preview">
            <div class="preview-header">Watermarked</div>
            <iframe id="wm-preview"></iframe>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Processing PDF...</p>
      </div>
    </div>
    
    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-wave"></div>
      <div class="footer-content">
        <div class="footer-logo">
          <img src="../images/logo.svg" alt="The Dollar Web Logo" style="width: 48px; height: 48px;">
          <span>&nbsp;The Dollar Web</span>
        </div>
        <div class="footer-links">
          <a href="../index.html">Home</a>
          <a href="../about.html">About</a>
          <a href="../contact.html">Contact</a>
          <a href="../privacy.html">Privacy Policy</a>
          <a href="../terms.html">Terms of Service</a>
        </div>
        <div class="footer-social">
          <a href="https://x.com/thedollarweb" aria-label="Twitter">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Z"/>
            </svg>
          </a>
          <a href="https://www.instagram.com/thedollarwebpro/" aria-label="Instagram">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
          </a>
          <a href="https://www.linkedin.com/company/the-dollar-web" aria-label="LinkedIn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
              <rect x="2" y="9" width="4" height="12"></rect>
              <circle cx="4" cy="4" r="2"></circle>
            </svg>
          </a>
        </div>
        <p class="copyright">&copy; 2025 The DollarWeb</p>
        <p class="copyright-message">Professional tools that won't break the bank</p>
      </div>
    </footer>
  
    <!-- PDF.js Script -->
    <script src="../libs/pdf-lib.min.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if PDFLib is loaded
        if (typeof PDFLib === 'undefined') {
          console.error('PDF-lib library not loaded');
          alert('The PDF processing library failed to load. Please refresh the page and try again.');
          return;
        }
        
        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        
        // DOM references
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const statusEl = document.getElementById('status');
        const watermarkText = document.getElementById('watermark-text');
        const fontSize = document.getElementById('font-size');
        const colorPicker = document.getElementById('color-picker');
        const opacity = document.getElementById('opacity');
        const opacityVal = document.getElementById('opacity-val');
        const position = document.getElementById('position');
        const docName = document.getElementById('doc-name');
        const addWatermarkBtn = document.getElementById('add-watermark-btn');
        const downloadBtn = document.getElementById('download-btn');
        const downloadContainer = document.getElementById('download-container');
        const previewContainer = document.getElementById('preview-container');
        const origPreview = document.getElementById('orig-preview');
        const wmPreview = document.getElementById('wm-preview');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        let selectedFile = null;
        
        // Update opacity value display
        opacity.addEventListener('input', function() {
          opacityVal.textContent = `${this.value}%`;
        });
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop zone when dragging over
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
        
        // Click to browse
        dropZone.querySelector('.link').addEventListener('click', function() {
          fileInput.click();
        });
        
        // File input change
        fileInput.addEventListener('change', function() {
          if (this.files.length) {
            handleFiles(this.files);
          }
        });
        
        // Add event listeners
        addWatermarkBtn.addEventListener('click', addWatermark);
        downloadBtn.addEventListener('click', downloadWatermarkedPDF);
        
        // Functions
        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        function highlight() {
          dropZone.classList.add('highlight');
        }
        
        function unhighlight() {
          dropZone.classList.remove('highlight');
        }
        
        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles(files);
        }
        
        function handleFiles(files) {
          if (files.length) {
            updateStatus('', '');
            const file = files[0];
            
            if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
              selectedFile = file;
              
              // Set default document name
              const fileName = file.name;
              const nameWithoutExtension = fileName.substring(0, fileName.lastIndexOf('.')) || fileName;
              docName.value = `${nameWithoutExtension}_watermarked`;
              
              // Create URL for preview
              const url = URL.createObjectURL(file);
              
              // Update UI
              origPreview.src = url;
              addWatermarkBtn.disabled = false;
              previewContainer.classList.remove('hidden');
              
              updateStatus(`File selected: ${file.name}`, 'success');
            } else {
              updateStatus('Please select a PDF file', 'error');
            }
          }
        }
        
        function updateStatus(message, type) {
          if (!message) {
            statusEl.style.display = 'none';
            return;
          }
          
          statusEl.textContent = message;
          statusEl.className = type;
          statusEl.style.display = 'block';
        }
        
        function showLoading() {
          loadingIndicator.classList.add('active');
        }
        
        function hideLoading() {
          loadingIndicator.classList.remove('active');
        }
        
        // Global variable to store watermarked PDF blob
        let watermarkedPdfBlob = null;
        
        async function addWatermark() {
          if (!selectedFile) {
            updateStatus('No file selected', 'error');
            return;
          }
          
          const text = watermarkText.value.trim();
          if (!text) {
            updateStatus('Please enter watermark text', 'error');
            return;
          }
          
          showLoading();
          updateStatus('', '');
          
          try {
            // Read file as ArrayBuffer
            const arrayBuffer = await readFileAsArrayBuffer(selectedFile);
            
            // Load PDF
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            const pages = pdfDoc.getPages();
            const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            // Get watermark settings
            const fontSizeValue = parseInt(fontSize.value);
            const [r, g, b] = hexToRgb(colorPicker.value);
            const opacityValue = parseInt(opacity.value) / 100;
            const positionValue = position.value;
            
            // Apply watermark to each page
            pages.forEach(page => {
              const { width, height } = page.getSize();
              
              if (positionValue === 'center') {
                // Center watermark
                const textWidth = font.widthOfTextAtSize(text, fontSizeValue);
                const x = (width - textWidth) / 2;
                const y = (height - fontSizeValue) / 2;
                
                page.drawText(text, {
                  x, y,
                  size: fontSizeValue,
                  font,
                  color: rgb(r, g, b),
                  opacity: opacityValue
                });
              } else if (positionValue === 'diagonal') {
                // Diagonal watermark from bottom-left to top-right
                const textWidth = font.widthOfTextAtSize(text, fontSizeValue);
                
                // Calculate the center point of the page
                const centerX = width / 2;
                const centerY = height / 2;
                
                // Calculate the angle for the diagonal (bottom-left to top-right)
                const angle = Math.atan2(height, width);
                const angleDegrees = angle * (180 / Math.PI);
                
                // The PDF origin is at bottom-left, and text is drawn from bottom-left
                // When rotating text, we need to adjust the position so it stays centered
                // Create an offset to position text in the true center of the page
                // This is approximately 1/4 of the diagonal length to shift it down and left
                const diagonalLength = Math.sqrt(width * width + height * height);
                const offset = diagonalLength / 8;
                
                page.drawText(text, {
                  // Adjust position to be more centered on the page
                  x: centerX - offset,
                  y: centerY - offset,
                  size: fontSizeValue,
                  font,
                  color: rgb(r, g, b),
                  opacity: opacityValue,
                  rotate: {
                    type: 'degrees',
                    angle: angleDegrees
                  }
                });
              } else if (positionValue === 'top') {
                // Top watermark
                const textWidth = font.widthOfTextAtSize(text, fontSizeValue);
                const x = (width - textWidth) / 2;
                const y = height - fontSizeValue - 20; // 20px padding from top
                
                page.drawText(text, {
                  x, y,
                  size: fontSizeValue,
                  font,
                  color: rgb(r, g, b),
                  opacity: opacityValue
                });
              } else if (positionValue === 'bottom') {
                // Bottom watermark
                const textWidth = font.widthOfTextAtSize(text, fontSizeValue);
                const x = (width - textWidth) / 2;
                const y = 40; // 40px from bottom
                
                page.drawText(text, {
                  x, y,
                  size: fontSizeValue,
                  font,
                  color: rgb(r, g, b),
                  opacity: opacityValue
                });
              } else if (positionValue === 'repeated') {
                // Repeated/tiled watermark
                const textWidth = font.widthOfTextAtSize(text, fontSizeValue);
                const tileSize = textWidth + 100; // Space between watermarks
                
                // Calculate number of rows and columns
                const cols = Math.ceil(width / tileSize);
                const rows = Math.ceil(height / tileSize);
                
                // Draw tiled watermarks
                for (let row = 0; row < rows; row++) {
                  for (let col = 0; col < cols; col++) {
                    const x = col * tileSize;
                    const y = row * tileSize;
                    
                    page.drawText(text, {
                      x, y,
                      size: fontSizeValue,
                      font,
                      color: rgb(r, g, b),
                      opacity: opacityValue
                    });
                  }
                }
              }
            });
            
            // Generate watermarked PDF
            const bytes = await pdfDoc.save();
            watermarkedPdfBlob = new Blob([bytes], { type: 'application/pdf' });
            const wmURL = URL.createObjectURL(watermarkedPdfBlob);
            
            // Preview watermarked PDF
            wmPreview.src = wmURL;
            
            // Show download section and update status
            downloadContainer.style.display = 'block';
            updateStatus('Watermark added successfully! Review the preview and download your file.', 'success');
            
          } catch (error) {
            console.error('Error processing PDF:', error);
            updateStatus(`Error adding watermark: ${error.message || 'Unknown error'}`, 'error');
          } finally {
            hideLoading();
          }
        }
        
        function downloadWatermarkedPDF() {
          if (!watermarkedPdfBlob) {
            updateStatus('Please add a watermark first', 'error');
            return;
          }
          
          // Get document name
          let downloadFileName = docName.value.trim();
          if (!downloadFileName) {
            // If no name provided, create one based on original file
            const originalName = selectedFile.name;
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            downloadFileName = `${nameWithoutExt}_watermarked.pdf`;
          } else if (!downloadFileName.toLowerCase().endsWith('.pdf')) {
            downloadFileName += '.pdf';
          }
          
          // Download the file
          downloadFile(watermarkedPdfBlob, downloadFileName);
          
          updateStatus('PDF downloaded successfully!', 'success');
        }
        
        // Helper functions
        function readFileAsArrayBuffer(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
              resolve(e.target.result);
            };
            
            reader.onerror = function(e) {
              reject(new Error('Error reading file'));
            };
            
            reader.readAsArrayBuffer(file);
          });
        }
        
        function hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result 
            ? [
                parseInt(result[1], 16) / 255, 
                parseInt(result[2], 16) / 255, 
                parseInt(result[3], 16) / 255
              ] 
            : [0, 0, 0];
        }
        
        function downloadFile(blob, fileName) {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          
          // Clean up
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
          }, 100);
        }
      });
    </script>
  </body>
</html>